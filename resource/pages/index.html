<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KAKAOMAP</title>

    <!-- 카카오맵 API -->
    <script type="text/javascript" src="/api/kakao/maps-sdk"></script>


    <!-- 부트스트랩 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
          crossorigin="anonymous">
</head>
<body>

    <!-- 부트스트랩 -->
    <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
            crossorigin="anonymous">
    </script>

    <!--    Grafana panel    -->
    <div class="container">

        <iframe src="http://localhost:3000/d-solo/38eedacf-2392-420d-8c4f-83a81cc1c579/graph?orgId=1&from=1756185304902&to=1756188904902&timezone=browser&refresh=1m&panelId=2&__feature.dashboardSceneSolo=true" width="450" height="200" frameborder="0"></iframe>

    </div>


    <!--    마커 필터 스위치    -->
    <div class="container">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="switchDetected" checked>
            <label class="form-check-label" for="switchDetected">발견</label>
        </div>

        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="switchDetectedAgain" checked>
            <label class="form-check-label" for="switchDetectedAgain">재발견</label>
        </div>

        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="switchKilled" checked>
            <label class="form-check-label" for="switchKilled">사체 발견</label>
        </div>

        <!--    카카오 맵    -->
        <div id="map" style="width:60%;height:500px;"></div>

    </div>


    <script>
        var map_container = document.getElementById('map'), // 지도를 표시할 div
            map_option = {
                center: new kakao.maps.LatLng(36.46201132199759, 127.8490946787158), // 지도의 중심좌표
                level: 13    // 지도의 확대 레벨
            };

        var map = new kakao.maps.Map(map_container, map_option);

        // 지도에 표시 될 마커 객체를 가지고 있을 배열
        const detected_markers = [];
        const detected_again_markers = [];
        const killed_markers = [];

        //  마커 종류별 이미지
        const red_image = "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
        const yellow_image = "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
        const green_image = "https://maps.google.com/mapfiles/ms/icons/green-dot.png"

        // 실제로 지도에 추가 될 마커 객체를 담을 배열
        const marker_object_list = [];

        // 데이터 받는 함수
        function fetchData() {
            fetch("http://localhost:4321/api/kakao/get-data")
                .then((response) => response.json())
                .then((data) => {
                    // 배열 초기화
                    detected_markers.length = 0;
                    detected_again_markers.length = 0;
                    killed_markers.length = 0;

                    // 데이터 받아와서 배열에 넣기
                    data.forEach(item => {
                        const latlng = new kakao.maps.LatLng(item.latitude, item.longitude);
                        const data_item = {
                            latlng: latlng,
                            content: item.road,
                            status: item.status
                        };

                        //  status 별 따로 정보 담기
                        if (item.status === 0) {
                            detected_markers.push(data_item);
                        } else if (item.status === 1) {
                            detected_again_markers.push(data_item);
                        } else if (item.status === 2) {
                            killed_markers.push(data_item);
                        }
                    });

                    // 데이터 업데이트 후 마커 업데이트
                    updateMarkers();
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        // 5초마다 데이터 업데이트
        setInterval(fetchData, 5000);

        // 스위치 확인
        const checkbox1 = document.getElementById('switchDetected');
        const checkbox2 = document.getElementById('switchDetectedAgain');
        const checkbox3 = document.getElementById('switchKilled');

        // 스위치에 이벤트 리스너 추가
        checkbox1.addEventListener("change", updateMarkers);
        checkbox2.addEventListener("change", updateMarkers);
        checkbox3.addEventListener("change", updateMarkers);

        // 스위치 상태에 따라 마커를 업데이트하는 함수
        function updateMarkers() {

            // 기존 마커 모두 제거
            marker_object_list.forEach(marker => marker.setMap(null));
            marker_object_list.length = 0; // 배열 초기화

            if (checkbox1.checked) {
                addMarkers(detected_markers);
            }
            if (checkbox2.checked) {
                addMarkers(detected_again_markers);
            }
            if (checkbox3.checked) {
                addMarkers(killed_markers);
            }
        }

        //  마우스 호버 액션리스너
        function makeOverListener(map, marker, info_window) {
            return function() {
                info_window.open(map, marker);
            };
        }

        function makeOutListener(info_window) {
            return function() {
                info_window.close();
            };
        }

        // 마커를 추가하는 함수
        function addMarkers(positions) {
            for (var i = 0; i < positions.length; i++) {
                var src = positions[i].status === 0 ? green_image : (positions[i].status === 1 ? yellow_image : red_image);

                var img = new kakao.maps.MarkerImage(
                    src,
                    new kakao.maps.Size(32, 34),
                    {offset: new kakao.maps.Point(27, 69)}
                );

                var marker = new kakao.maps.Marker({
                    map: map,
                    position: positions[i].latlng,
                    image: img
                });

                //  생성한 마커를 배열에 추가
                marker_object_list.push(marker);

                var infowindow = new kakao.maps.InfoWindow({
                    content: positions[i].content
                });

                kakao.maps.event.addListener(marker, 'mouseover', makeOverListener(map, marker, infowindow));
                kakao.maps.event.addListener(marker, 'mouseout', makeOutListener(infowindow));
            }
        }

        // 페이지 로드 시 초기 마커를 표시하기 위해 fetchData 함수 호출
        fetchData();
    </script>
</body>
</html>